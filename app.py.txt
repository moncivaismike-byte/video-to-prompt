import streamlit as st
import cv2
from PIL import Image
import numpy as np
import time

# ç½‘é¡µæ ‡é¢˜å’Œä¸­æ–‡è®¾ç½®
st.set_page_config(page_title="Nano Banana è§†é¢‘æ‹†è§£åŠ©æ‰‹", layout="wide")

st.title("ğŸ¬ Nano Banana è§†é¢‘é•œå¤´ AI æŠ½å¸§å·¥å…·")
st.markdown("---")

# ä¾§è¾¹æ ï¼šè®¾ç½®
st.sidebar.header("âš™ï¸ å‚æ•°è®¾ç½®")
sampling_rate = st.sidebar.slider("æŠ½å¸§é¢‘ç‡ï¼ˆæ¯ç§’å‡ å¸§ï¼‰", 0.5, 5.0, 1.0)
api_key = st.sidebar.text_input("è¾“å…¥ä½ çš„ Nano Banana API å¯†é’¥", type="password")

# ä¸Šä¼ è§†é¢‘
uploaded_file = st.file_uploader("è¯·ä¸Šä¼  MP4 æˆ– MOV æ ¼å¼è§†é¢‘", type=["mp4", "mov"])

if uploaded_file is not None:
    # ä¸´æ—¶ä¿å­˜è§†é¢‘ä»¥ä¾¿å¤„ç†
    with open("input_video.mp4", "wb") as f:
        f.write(uploaded_file.getbuffer())
    
    st.video(uploaded_file)

    if st.button("ğŸš€ å¼€å§‹é€å¸§æ‹†è§£å¹¶ç”Ÿæˆ AI æç¤ºè¯"):
        if not api_key:
            st.error("è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥ API å¯†é’¥ï¼")
        else:
            video = cv2.VideoCapture("input_video.mp4")
            fps = video.get(cv2.CAP_PROP_FPS)
            step = int(fps / sampling_rate)
            
            count = 0
            frame_idx = 0
            
            st.subheader("ğŸ“ é•œå¤´æ‹†è§£ç»“æœ")
            
            while video.isOpened():
                ret, frame = video.read()
                if not ret:
                    break
                
                if count % step == 0:
                    frame_idx += 1
                    # è½¬æ¢å›¾ç‰‡æ ¼å¼
                    frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                    img = Image.fromarray(frame_rgb)
                    
                    # ç•Œé¢å¸ƒå±€
                    col1, col2 = st.columns([1, 2])
                    with col1:
                        st.image(img, caption=f"é•œå¤´ {frame_idx}")
                    with col2:
                        # è¿™é‡Œæ¨¡æ‹Ÿè°ƒç”¨ Nano Banana API
                        # å®é™…éƒ¨ç½²æ—¶ï¼Œæˆ‘ä¼šå¸®ä½ æ¥å…¥çœŸå®çš„ requests è¯·æ±‚
                        st.info(f"æ­£åœ¨åˆ†æç¬¬ {frame_idx} ä¸ªé•œå¤´...")
                        placeholder_prompt = f"Cinematic, high resolution, masterpiece, lighting focus, frame_{frame_idx}"
                        st.text_area(f"AI æç¤ºè¯ {frame_idx}", value=placeholder_prompt, height=100)
                        st.button(f"å¤åˆ¶æç¤ºè¯", key=f"btn_{frame_idx}")
                    st.markdown("---")
                
                count += 1
            video.release()
            st.success("åˆ†æå®Œæˆï¼")